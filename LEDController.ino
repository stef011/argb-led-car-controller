#include "config.h"
#include "effects.h"
#include "inputs.h"

// #include <FastLED.h>

CRGB leds[NUM_LEDS];

bool isInitialized = false;

int tableState = 0;
int state = 0;

int potBrightness;
int potColor;
int potDelay;
int potMisc;

int brightness;

bool currentUpState;
bool lastUpState;
bool upStateChange;
bool downStateChange;
bool currentDownState;
bool lastDownState;
int sequence;


CHSV color;
CHSV secondaryColor;

void setup() {
  // Init buttons and potentiometers
  pinMode(BUTTON_PLUS_PIN, INPUT);
  pinMode(BUTTON_MINUS_PIN, INPUT);
  pinMode(POT_BRIGHTNESS, INPUT);
  pinMode(POT_COLOR, INPUT);
  pinMode(POT_DELAY, INPUT);
  pinMode(POT_MISC, INPUT);

  // Init Modules
  initializeEffects();

  // Serial.begin(9600);

  // Setup FastLED
  FastLED.addLeds<WS2812, LED_PIN, GRB>(leds, NUM_LEDS);
  FastLED.setMaxPowerInVoltsAndMilliamps(5, 500);
  FastLED.setBrightness(MAX_BRIGHTNESS);
  FastLED.clear();
  FastLED.show();
  delay(1000); // Sanity delay
}

void loop() {
  resetTableState();

  // Read potentiometers
  potBrightness = analogRead(POT_BRIGHTNESS);
  potColor = analogRead(POT_COLOR);
  potDelay = analogRead(POT_DELAY);
  potMisc = analogRead(POT_MISC);

  // Serial.print("Brightness: ");
  // Serial.println(potBrightness);
  // Serial.print("Color: ");
  // Serial.println(potColor);
  // Serial.print("Delay: ");
  // Serial.println(potDelay);
  // Serial.print("Misc: ");
  // Serial.println(potMisc);


  brightness = (int)(((float)potBrightness /1023) * MAX_BRIGHTNESS);
  color = potToCHSV(potColor);
  secondaryColor = potToCHSV(potMisc);
  


  // Manage up button press
  currentUpState = readButton(BUTTON_PLUS_PIN);
  upStateChange = checkForChange(currentUpState, lastUpState);
  if (upStateChange && currentUpState){
    sequence = cycleCounter(sequence, false);
    FastLED.clear();
    tableState = 0;
  }
  lastUpState = currentUpState;

  // Manage down button press
  currentDownState = readButton(BUTTON_MINUS_PIN);
  downStateChange = checkForChange(currentDownState, lastDownState);
  if (downStateChange && currentDownState){
    sequence = cycleCounter(sequence, true);
    FastLED.clear();
    tableState = 0;
  }
  lastDownState = currentDownState;

  // Run effects
switch (sequence) {
  case 0: // Solid
    still(color);
    break;
  case 1: // Forth color light (sawblade effect)
    colorWipe(color, (int)(((float)potDelay /1023) * 20), (int)(((float)potMisc / 1023) * 20));
    break;
  case 2: // Back and forth color light (sinusoide effect)
    backAndForth(color, (int)(((float)potDelay /1023) * 20), (int)(((float)potMisc / 1023) * 20));
    break;
  case 3: // Rainbow
    rainbow(color, secondaryColor);
    break;
  case 4: // Moving Rainbow
    movingRainbow((int)(((float)potDelay /1023) * 50), (int)(((float)potColor /1023) * 255));
    break;
  case 5: // Random colors generated by sine waves
    sinelon(color, (int)(((float)potDelay / 1023) * 50)); // TODO: Control parameters (colors, speed and fading)
    break;
  // case 4: //
  //   bpm(color); 
  //   break;


}

  // FastLED.setBrightness((int)(((float)potBrightness /1023) * 255));
  FastLED.show();
}

void resetTableState() {
  if (tableState >= NUM_LEDS) {
    tableState = 0;
  }
}
